<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">backbone-parse-es6-todos-improved/site/js/App.js | typhonjs-backbone-parse-todos API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/typhonjs-demos/typhonjs-backbone-parse-todos/typhonjs-backbone-parse-todos.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">backbone-es6/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/Backbone.js~Backbone.html">Backbone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/Collection.js~Collection.html">Collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/Debug.js~Debug.html">Debug</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/History.js~History.html">History</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/Utils.js~Utils.html">Utils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-es6@master/src/View.js~View.html">View</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extend">extend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sync">sync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BackboneProxy">BackboneProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-collection">collection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-model">model</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">(backbone-parse-es6):<br>backbone/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-parse-es6@master/src/ParseCollection.js~ParseCollection.html">ParseCollection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/backbone-parse-es6@master/src/ParseModel.js~ParseModel.html">ParseModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-modelExtend">modelExtend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseExtend">parseExtend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseSync">parseSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-parseCollection">parseCollection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-parseModel">parseModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typhonjs-core-backbone-common/src</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-typhonExtend">typhonExtend</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typhonjs-core-backbone-events-logged/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-backbone-events-logged@master/src/TyphonLoggedEvents.js~TyphonLoggedEvents.html">TyphonLoggedEvents</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typhonjs-core-backbone-events/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-backbone-events@master/src/Events.js~Events.html">Events</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-backbone-events@master/src/TyphonEvents.js~TyphonEvents.html">TyphonEvents</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typhonjs-core-backbone-query/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-backbone-query@master/src/BackboneQuery.js~BackboneQuery.html">BackboneQuery</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typhonjs-core-logging/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-logging@master/src/ConsoleLogger.js~ConsoleLogger.html">ConsoleLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-logging@master/src/Logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typhonjs-core-utils/src</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-utils@master/src/MultiMap.js~MultiMap.html">MultiMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/jspm_packages/github/typhonjs/typhonjs-core-utils@master/src/Utils.js~Utils.html">Utils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-btoa">btoa</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">site/js</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">site/js/collections</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/collections/todoList.js~TodoList.html">TodoList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-todoList">todoList</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">site/js/models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/models/Item.js~Item.html">Item</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/models/appState.js~AppState.html">AppState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-appState">appState</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">site/js/router</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/router/AppRouter.js~AppRouter.html">AppRouter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">site/js/views</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/views/ItemView.js~ItemView.html">ItemView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/views/LogInView.js~LogInView.html">LogInView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/backbone-parse-es6-todos-improved/site/js/views/ManageTodosView.js~ManageTodosView.html">ManageTodosView</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">backbone-parse-es6-todos-improved/site/js/App.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import Backbone         from &apos;backbone&apos;;
import Parse            from &apos;parse&apos;;
import eventbus         from &apos;mainEventbus&apos;;

import AppRouter        from &apos;pathSite/js/router/AppRouter.js&apos;;
import LogInView        from &apos;pathSite/js/views/LogInView.js&apos;;
import ManageTodosView  from &apos;pathSite/js/views/ManageTodosView.js&apos;;

import appState         from &apos;pathSite/js/models/appState.js&apos;;
import todoList         from &apos;pathSite/js/collections/todoList.js&apos;;

/**
 * Provides the main entry point for the Todos app and major control functionality (the C in MVC). This control
 * functionality is exposed over an eventbus created by `mainEventbus.js`. `typhonjs-backbone-parse` provides
 * additional functionality particularly for `Backbone.Events` adding the ability to invoke asynchronous actions
 * over the eventbus using the `triggerThen` method which resolves any Promises returned by event targets.
 *
 * While in this simple app there is only one view of the `TodoList` a benefit of separating control functionality and
 * the `TodoList` instance from a specific view is that it could be used across multiple views.
 *
 * Please note that all Parse specific API access is isolated in this class. By isolating Parse API access to
 * just this class if the app was rewritten to use a different backend then only this class needs to be modified
 * to support the new backend API after selecting an alternate Backbone implementation.
 */
export default class App
{
   /**
    * Wires up the main eventbus, invokes the private s_INITIALIZE_ROUTE function which creates `AppRouter` and sets up
    * a catch all handler then invokes `Backbone.history.start` with the root path and finally the constructor shows the
    * proper view based on whether there is a current logged in user.
    */
   constructor()
   {
      // Wire up the main eventbus to respond to the following events. By passing in `this` in the third field to
      // `on` that sets the context when the callback is invoked.
      eventbus.on(&apos;app:create:item&apos;, this.createItem, this);
      eventbus.on(&apos;app:select:filter&apos;, this.selectFilter, this);
      eventbus.on(&apos;app:user:is:current&apos;, this.isUserCurrent, this);
      eventbus.on(&apos;app:user:login&apos;, this.logInUser, this);
      eventbus.on(&apos;app:user:logout&apos;, this.logOutUser, this);
      eventbus.on(&apos;app:user:signup&apos;, this.signUpUser, this);

      // Invokes a private method to initialize the `AppRouter`, add a default catch all handler, and start
      // `Backbone.history`.
      s_INITIALIZE_ROUTE();

      // Get the current user and show the proper initial view given whether a user is currently logged in to the app.
      const user = Parse.User.current();

      /**
       * Creates the initial displayed view based given if a user is currently logged into the app.
       *
       * @type {View} Stores the current active view.
       */
      this.currentView = user !== null ? this.showTodos(user.escape(&apos;username&apos;)) : new LogInView();
   }

   /**
    * Creates a new Item in the todos list. Note the addition of user which becomes a Parse pointer and an
    * Parse.ACL (access control list) which limits the item to be only accessible to the current user.
    *
    * @param {string}   content - The text for the item.
    */
   createItem(content)
   {
      const user = Parse.User.current();

      // Ensure that content is a string and there is a currently logged in user. If so then create a new
      // `Item` entry in `todoList`.
      if (typeof content === &apos;string&apos; &amp;&amp; user !== null)
      {
         todoList.create(
         {
            content,
            order: todoList.nextOrder(),
            done: false,
            user,                      // Current user is assigned as a pointer.
            ACL: new Parse.ACL(user)   // An ACL with the current user ensures that it is only accessible by this user.
         });
      }
   }

   /**
    * Returns a boolean indicating if a user is logged into the app.
    *
    * @returns {boolean}
    */
   isUserCurrent()
   {
      return Parse.User.current() !== null;
   }

   /**
    * Logs in the user and invokes `showTodos` on success.
    *
    * Please note that an ES6 Promise wraps the Parse API call and this promise is resolved by the TyphonJS eventbus
    * via Promise.all before executing any handlers by the callee of `triggerThen`.
    *
    * @param {object}   data - An object that has username &amp; password entries.
    * @returns {Promise}
    */
   logInUser(data = {})
   {
      return new Promise((resolve, reject) =&gt;
      {
         // Invoke `showTodos` on the success.
         Parse.User.logIn(data.username, data.password).then((user) =&gt;
         {
            this.showTodos(user.escape(&apos;username&apos;));
            resolve(user);
         },
         (error) =&gt; { reject(error); });
      });
   }

   /**
    * Logs out the user and shows the login view.
    *
    * Please note that an ES6 Promise wraps the Parse API call and this promise is resolved by the TyphonJS eventbus
    * via Promise.all before executing any handlers by the callee of `triggerThen`.
    *
    * @returns {Promise}
    */
   logOutUser()
   {
      return new Promise((resolve, reject) =&gt;
      {
         // Close any current view and create the LogInView on success.
         Parse.User.logOut().then(() =&gt;
         {
            if (this.currentView) { this.currentView.close(); }
            this.currentView = new LogInView();
            appState.set(&apos;filter&apos;, &apos;all&apos;);
         },
         (error) =&gt; { reject(error); });
      });
   }

   /**
    * Sets the app state with the new filter type and updates `Backbone.History`.
    *
    * @param {string}   filter - Filter type to select.
    */
   selectFilter(filter)
   {
      // When setting a value on a `Backbone.Model` if the value is the same as what is being set a change event will
      // not be fired. In this case we set the new state with the `silent` option which won&apos;t fire any events then
      // we manually trigger a change event so that any listeners respond regardless of the original state value.
      appState.set({ filter }, { silent: true });
      appState.trigger(&apos;change&apos;, appState);

      // Update the history state with the new filter type.
      Backbone.history.navigate(filter);
   }

   /**
    * Creates and shows a new ManageTodosView then sets a new `Parse.Query` for `todoList` for the current user and
    * fetches the collection.
    *
    * @param {string}   username - Name of current user.
    * @returns {*}
    */
   showTodos(username)
   {
      if (this.currentView) { this.currentView.close(); }

      Backbone.history.navigate(appState.get(&apos;filter&apos;), { replace: true });

      // Create a new ManageTodosView and pass in the username via optional parameters. In a Backbone.View additional
      // options are available via `this.options.&lt;key&gt;`. Passing in the user name to the view allows the Parse API
      // isolated to just `App.js`.
      this.currentView = new ManageTodosView({ username });

      // Set the `todoList` query which is necessary for Parse backed collections. The `equalTo` qualifier returns
      // items that are associated with the current user.
      todoList.query = new Parse.Query(todoList.model);
      todoList.query.equalTo(&apos;user&apos;, Parse.User.current());

      // Fetch all the todos items for this user. Any listeners for `todoList` reset events will be invoked.
      todoList.fetch({ reset: true });

      return this.currentView;
   }

   /**
    * Potentially signs up a new user and if successful invokes `showTodos`.
    *
    * Please note that an ES6 Promise wraps the Parse API call and this promise is resolved by the TyphonJS eventbus
    * via Promise.all before executing any handlers by the callee of `triggerThen`.
    *
    * @param {object}   data - An object that has username &amp; password entries.
    * @returns {Promise}
    */
   signUpUser(data = {})
   {
      return new Promise((resolve, reject) =&gt;
      {
         // Invoke `showTodos` on the success.
         Parse.User.signUp(data.username, data.password, { ACL: new Parse.ACL() }).then((user) =&gt;
         {
            this.showTodos(user.escape(&apos;username&apos;));
            resolve(user);
         },
         (error) =&gt; { reject(error); });
      });
   }
}

/**
 * A private function in the module scope, but outside of the class which initializes the `AppRouter`, adds a default
 * catch all handler, and start `Backbone.history`.
 */
const s_INITIALIZE_ROUTE = () =&gt;
{
   new AppRouter();

   // Defines a catch all handler for all non-matched routes (anything that isn&apos;t `all`, `active` or `completed`). If
   // a user is logged in the catch all navigates to `all` triggering the route and replacing the invalid route in
   // the browser history.
   Backbone.history.handlers.push(
   {
      route: /(.*)/,
      callback: () =&gt;
      {
         if (Parse.User.current() !== null)
         {
            Backbone.history.navigate(&apos;all&apos;, { trigger: true, replace: true });
         }
         else
         {
            Backbone.history.navigate(&apos;&apos;, { replace: true });
         }
      }
   });

   // This regex matches the root path, so that it can be set in `Backbone.history.start`
   let root, urlMatch;

   // Construct the root path to the web app which is the path above the domain that may include `index.html` or
   // `indexSrc.html` depending on the runtime. For instance in WebStorm when creating a local server `index.html` is
   // included in the URL. Running on an actual web server often `index.html` is not put into the URL. When running the
   // app from source code transpiled in the browser `indexSrc.html` is always in the URL.
   if (typeof window.location !== &apos;undefined&apos;)
   {
      const windowLocation = window.location.toString();

      if (windowLocation.includes(&apos;.html&apos;))
      {
         urlMatch = windowLocation.match(/\/\/[\s\S]*\/([\s\S]*\/)([\s\S]*\.html)/i);
         root = urlMatch &amp;&amp; urlMatch.length &gt;= 3 ? `${urlMatch[1]}${urlMatch[2]}` : undefined;
      }
      else
      {
         urlMatch = windowLocation.match(/\/\/[\s\S]*\/([\s\S]*\/)/i);
         root = urlMatch &amp;&amp; urlMatch.length &gt;= 2 ? urlMatch[1] : undefined;
      }
   }

   Backbone.history.start({ root });
};</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
